# 업무에 바로 쓰는 SQL 튜닝

## 책 소개

 - 제목: 업무에 바로 쓰는 SQL 튜닝
    - 부제: 최적의 성능을 위한 MySQL/MariaDB 쿼리 작성과 튜닝 실습
 - 지은이: 양바른
 - 펴낸이: 김태헌
 - 펴낸곳: 한빛미디어(주)
 - 초판 1쇄 발행: 2021년 07월 01일

<br/>

## 대상 독자

MySQL이나 MariaDB에서 SQL 튜닝을 시작하려는 독자 대상의 튜닝 입문서  
실제 비즈니스에서 마주할 수 있는 악성 SQL 문의 사례를 통해 SQL 문을 분석하고 쿼리를 튜닝하는 과정을 함께 수행  

<br/>

## 개발 환경 및 예제 파일
 - 개발 환경
    - MySQL 8.0.21 버전 및 MariaDB 10.5.4 버전
 - 깃허브 저장소: https://github.com/7ieon/SQLtune

<br/>

## 목차

 - CHAPTER 1 MySQL과 MariaDB 개요
    - MySQL과 MariaDB의 배경과 시장점유율 현황을 알아보고 상용 DBMS와의 차이점, 오픈소스 DBMS인 MySQL과 MariaDB 튜닝 중요성을 살펴본다.
 - CHAPTER 2 SQL 튜닝 용어를 직관적으로 이해하기
    - SQL 튜닝을 수행하기 전 알아야 하는 물리 엔진의 구조, DB 오브젝트 관련 용어, 논리적인 쿼리문 작성 관련 용어, 개념적으로 통용되는 튜닝 용어를 알아본다.
 - CHAPTER 3 SQL 튜닝의 실행 계획 파헤치기
    - SQL 튜닝을 수행하는 데 필요한 실습 환경을 구성하고, 실행 계획을 수행하는 방법과 출력 결과의 의미를 살펴본다.
 - CHAPTER 4 악성 SQL 튜닝으로 초보자 탈출하기
    - 주어진 SQL 문에서 단순한 텍스트 변경으로 튜닝을 수행하는 실습을 진행한다. SQL 문에서 일부 구문 또는 테이블 조인 방식을 변경하여 쿼리 튜닝을 수행하는 사례를 확인한다.
 - CHAPTER 5 악성 SQL 튜닝으로 전문가 되기
    - 주어진 SQL 문에서 쿼리를 재작성하거나 DDL을 통한 오브젝트 변경으로 튜닝을 수행하는 실습을 한다. SQL 문을 전체적으로 다시 작성하거나, 인덱스를 조정하고, 테이블과 열의 속성을 변경하는 방식으로 쿼리 튜닝을 수행하는 사례를 확인한다.

<br/>

## 주요 내용 (SQL 수행 흐름)

 - SQL 수행 흐름
   - 클라이언트 SQL 문 요청
   - 파서가 해당 SQL 문을 MySQL이 이해할 수 있는 최소 단위로 구성 요소를 분리하고 트리를 만든다. (문법 오류 검사)
   - 전처리기는 생성된 트리로 오브젝트(테이블, 뷰, 컬럼, 함수)을 검사하고, 접근 권한을 검증한다.
   - 옵티마이저는 전달받은 트리를 토대로 SQL 최적화(조건 제거, 연산 과정 단순화)를 진행한다. 또, 데이터를 가져오기 위한 실행 계획을 구성한다.
   - 엔진 실행기는 옵티마이저에서 수립한 실행 계획을 참고하여 스토리지 엔진에서 데이터를 가져온다.
   - MySQL 엔진은 스토리지 엔진으로부터 가져온 데이터를 정렬, 조인, 필터링 작업을 수행한다.

## 주요 내용 (실행 계획)

 - 실행 계획 확인하기
   - 'EXPLAIN', 'DESC' 키워드를 통해 SQL 문의 실행 계획을 확인할 수 있다.
 - id 컬럼
   - 실행 순서를 나타낸다. 값이 작을 수록 먼저 수행된 것이다.
 - select_type 컬럼
   - SELECT 쿼리가 어떤 유형인지 나타낸다.
   - SIMPLE: 단순 SELECT 쿼리
   - PRIMARY: 서브쿼리의 가장 바깥쪽 쿼리, UNION 포함된 SQL 문에서 가장 첫 번째 SELECT 쿼리
   - UNION: UNION을 사용한 경우 첫 번째 이후 SELECT 쿼리
   - DEPENDENT UNION: UNION을 사용한 경우 외부 쿼리에 영향을 받는 쿼리
   - SUBQUERY: FROM절 이외에 사용된 서브 쿼리
   - DERIVED: FROM절에 사용된 서브 쿼리
 - table 컬럼
   - 대상 테이블을 나타낸다.
 - type 컬럼
   - 테이블의 데이터를 어떻게 찾는지를 나타낸다.
   - system: 레코드가 0건 또는 1건인 테이블 조회
   - const: 개인키 혹은 유니크키를 통해 조회하여 조회되는 데이터가 1건일 경우 (WHERE 조건에 결과가 반드시 1건을 반환하는 쿼리)
   - eq_ref: 여러 테이블 조인을 수행할 때 고유 인덱스 또는 기본키로 동등 조건으로 조회하여 데이터가 1건일 경우 (1:1)
   - ref: 여러 테이블 조인을 수행할 때 인덱스 종류와 상관없이 동등 조건으로 일대다의 관계가 될 수 있다. (1:N)
   - range: 인덱스를 하나의 값이 아니라 범위로 검색하는 경우
   - index: 인덱스를 처음부터 끝까지 읽는 경우 (인덱스 풀 스캔)
   - ALL: 테이블 풀 스캔
 - possible_keys 컬럼
   - 옵티마이저가 쿼리 최적화를 위해 사용할 수 있는 후보 인덱스 목록을 나타낸다.
 - key 컬럼
   - possible_keys 컬럼에서 보여진 후보 인덱스 목록 중 실제 사용된 인덱스를 의미한다.
 - ref 컬럼
   - 테이블 조인을 수행할 때 어떤 조건으로 해당 테이블에 액세스되었는지를 나타낸다.
   - type 컬럼의 유형이 ref일 때 나타난다. (조인)
 - rows 컬럼
   - 옵티마이저가 비용을 산정하기 위해 얼마나 많은 레코드를 읽고 비교해야하는지 예측한 레코드 수를 나타낸다.
   - 쿼리 수행을 위한 디스크에서 데이터 파일을 읽고 메모리에서 처리해야 할 행 수
 - filtered 컬럼
   - SQL 문을 통해 DB 엔진으로 가져온 데이터 대상으로 필터 조건에 따라 어느 정도 비율로 데이터를 제거했는지를 나타낸다.
 - Extra 컬럼
   - SQL 문을 어떻게 수행했는지에 대한 정보를 나타낸다.
   - Distinct: 중복 제거가 포함되는 distinct 키워드나 union 구문이 포함된 경우 출력
   - Using where: WHERE 절의 필터 조건을 사용해 데이터를 추출
   - Using Temporary: 쿼리를 처리하는 동안 중간 결과를 담아 두기 위해 임시 테이블을 사용한다. DISTINCT, GROUP BY, ORDER BY 구문이 포함된 경우 임시 저장하고 데이터를 정렬, 중복 제거 작업을 수행한다.
   - Using filesort: 정렬 작업을 수행한다.
   - Using index: 물리적인 저장 장치에 접근하지 않고, 인덱스만을 읽어서 SQL 문의 요청사항을 처리한다. (커버링 인덱스)

<br/>

## 참고

 - https://jeong-pro.tistory.com/243
 - https://hmk1022.tistory.com/entry/%EC%BF%BC%EB%A6%AC-%EC%8B%A4%ED%96%89%EA%B3%84%ED%9A%8D-Query-Plan