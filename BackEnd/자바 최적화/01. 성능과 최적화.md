# 성능과 최적화

성능 분석은 경험주의와 인간 심리학이 교묘히 어우러진 분야이다. 중요한 건, 관측 지표의 절대 수치, 엔드 유저(최종 사용자)와 기타 이해관계자들이 그 수치를 어떻게 받아들이는가 하는 점이다.

## 1. 자바 성능: 잘못된 방법

자바 초창기에는 메서드 디스패치 성능이 좋지 않았다. 때문에, 메서드를 잘게 나누지 말고 하나의 덩치 큰 메서드로 작성하는 게 좋다고 권고하는 개발자도 있었다. 시간이 지나면서 가상 디스패치 성능이 엄청나게 좋아졌고, 최신 자바 가상 머신에서는 자동 인라이닝 덕분에 가상 디스패치 조차 대부분의 호출부에서 사라지게 되었다.

## 2. 자바 성능 개요

자바는 처음부터 지극히 실용적인 언어로 개발자 생산성이 높아지는 대가로 어느 정도 성능 희생은 감수할 만하다는 입장이다. 실용성을 추구하는 자바 플랫폼의 성격은 여러 방면에서 드러나며 가장 대표적으로 서브시스템(하위계)가 있다. **개발자가 일일이 용량을 세세하게 관리하는 부담을 덜어주고, 대신 저수준으로 제어 가능한 일부 기능을 포기하는 발상이다. (메모리 관리)**

JVM 애플리케이션에서 특이점(아웃라이어)은 매우 중요한 의미를 내포할 수 있다. 즉, 측정값을 샘플링(표본 추출)하면 특이점을 일으킨 가장 중요한 이벤트가 묻혀버릴 가능성이 크다.

## 3. 성능은 실험과학이다.

JVM 성능 튜닝은 기술, 방법론, 정량적 측정값, 툴을 망라한 개념으로 시스템 소유자/유저가 추구하는 측정 결과를 얻는 것이다.

- 원하는 결과를 정의한다.
- 기존 시스템을 측정한다.
- 요건을 충족시키려면 무슨 일을 해야 할지 정한다.
- 개선 활동을 추진한다.
- 다시 테스트한다.
- 목표가 달성됐는지 판단한다.

바람직한 성능 결과를 정의하고 판단하는 과정에서 정량적인 일련의 목표가 수립된다. 무엇을 측정할지 대상을 확정하고 목표를 기록하는 행위가 중요한데, 결국 이런 활동들이 프로젝트 아티팩트(결과물)와 제품 일부를 형성한다. 성능 분석은 비기능 요건을 정의하고 달성하는 활동이다.

## 4. 성능 분류

- 처리율, 지연, 용량, 사용률, 효율, 확장성, 저하

### 4-1. 처리율

**처리율은 서브 시스템이 수행 가능한작업 비율을 나타낸 지표이다. 보통 일정 시간 동안 완료한 작업 단위 수로 표시한다. (초당 처리 가능한 트랜잭션 수)**

- 처리율이 실제 성능을 반영하는 의미 있는 지표가 되려면 수치를 얻은 기준 플랫폼에 대해 내용을 기술해야 한다. (하드웨어 스팩, OS, 소프트웨어 스택, 테스트한 시스템이 단일 서버인지, 클러스터 환경인지 등)
- 트랜잭션은 테스트할 떄 마다 동일해야 한다.
- 처리율을 테스트할 떄 실행 간 워크로드는 일정하게 유지해야 한다.

### 4-2. 지연

1초에 100리터를 흘려보내는 수도관의 처리율은 바로 1초에 처리되는 부피(100리터)이다. 이떄, 지연은 수도관 자체의 길이에 해당한다. 즉, **하나의 트랜잭션을 처리하고 그 결과를 반대편 수도관 끝에서 바라볼 떄 까지 소요된 시간이다.**

### 4-3. 용량

용량은 시스템이 보유한 작업 병렬성의 총량, 즉 **시스템이 동시 처리 가능한 작업 단위(트랜잭션) 개수를 말한다.**

- 용량은 처리율과 밀접한 연관이 있다.
- 시스템에 동시 부하가 증가할수록 처리율도 당연히 영향 받는다.

### 4-4. 사용률

성능 분석 업무 중 가장 흔한 태스크는 시스템 리소스를 효율적으로 활용하는 것이다.

### 4-5. 효율

전체 시스템의 효율은 처리율을 리소스 사용률로 나눈 값으로 측정한다.

### 4-6. 확장성

처리율이나 시스템 용량은, 처리하는 데 끌어 쓸 수 있는 리소스에 달려 있다. 리소스 추가에 따른 처리율 변화는 시스템/애플리케이션의 확장성을 가늠하는 척도이다.

### 4-7. 저하

요청 개수가 증가하건, 요청 접수 속도가 증가하건, 어떤 형태로든 시스템이 더 많은 부하를 받으면 지연 또는 처리율 측정값에 변화가 생긴다.

### 4-8 측정값 사이의 연관 관계

JIT 컴파일 대상이 되는 메서드는 충분히 빈번하게 인터프리티드 모드로 실행돼야 한다. 따라서 부하가 적을 경우 핵심 메서드가 인터프리티드 모드의 늪에서 허우적거릴 가능성도 있지만, 부하가 많아 메서드 호출 빈도가 증가하면 JIT 컴파일 대상이 될 수도 있다. 결국 같은 메서드지만 나중에 호출하는 게 처음보다 훨씬 더 빨리 실행된다.

## 5. 성능 그래프 읽기

- 성능 엘보: 부하가 갑작스럽게 증가하면서 예기치 않게 저하가 발생하여 그래프가 급격히 증가한 상태
