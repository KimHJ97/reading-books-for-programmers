# 자바에서 발생 가능한 문제점들

## 1. 자바 기반의 시스템에서 발생할 수 있는 문제들

### 1-1. 어떤 문제가 발생할 수 있을까?

#### 시스템이 느려요

막연히 시스템이 느리다고 하기보다는 조금 더 상세히 구분해 놓는 것이 좋다.  
 - __전체 시스템이 항상 느린 경우__: 장비를 기동했을 때부터 느린 경우나 WAS를 시작했을 때부터 느린 경우
 - __특정 기능(화면)이 느린 경우__: 다른 화면은 괜찮지만, 특정 화면에만 들어가면 느려지거나 특정 기능만 느린 경우
 - __특정 시간대(기간)에 전체 애플리케이션이 느린 경우__: 전체 애플리케이션의 응답 속도가 괜찮다가 특정 시간대가 되면 애플리케이션의 속도가 느려지는 경우
 - __특정 시간대(기간)에 특정 애플리케이션이 느린 경우__: 앞의 경우처럼 전체 애플리케이션의 응답 속도가 괜찮다가도 특정 시간대에 특정 애플리케이션의 속도가 느려지는 경우
 - __특정 기능(화면)이 점점 느려지는 경우__: 특정 화면이 시스템 재시작 시에는 괜찮다가, 사용량이 많아지거나 날짜가 지날수록 점점 느려지는 경우
 - __특정 사용자만 애플리케이션이 느린 경우__: 이런 경우는 흔치 않지만, 특정 사용자만 애플리케이션이 느리다고 하소연하는 경우

이 중에서 문제의 원인을 가장 찾기 쉬운 것 은 "특정 기능(화면)이 느린 경우"이다. 애플리케이션의 흐름을 따라가면서 분석하면 된다. 반대로, 가장 원인을 찾기 어려운 경우는 "특정 시간대(기간)에 특정 애플리케이션이 느린 경우"이다. 원인을 찾기 어려운 이유는 재현이 쉽지 않기 때문이다. 즉, 원인을 찾는 과정은 그 문제를 얼마나 재현하기 쉬우냐에 따라서 난이도가 결정된다.  

여기서 나열한 문제점들은 원인이 매우 복합적으로 얽혀 있는 경우가 많지만, 대부분 scouter의 XLog와 스레드 상황을 확인해보면 시스템이 느려지는 원인을 찾는 데 매우 도움이 된다.  

#### 시스템 응답이 없어요

시스템 응답이 없는 경우와 죽는 경우가 같다고 볼 수 있지만, 실상은 엄연히 다르다. 시스템의 응답이 없다는 것은 프로세스가 살아있지만, 아무런 응답이 없는 경우를 말한다. 이러한 경우를 "시스템이 행(hang)이 되었다" 라고 표현할 수 있다.  
 - 사용자 입장
    - 모든 애플리케이션이 응답하지 않는 경우
    - 특정 기능(화면)이 응답하지 않는 경우
 - 개발자 입장
    - WAS 장비의 CPU 사용량은 10% 이내지만 시스템이 응답하지 않는 경우: 시스템 내/외적인 원인 때문에 정상적인 기능을 못 하는 경우
    - WAS 장비의 CPU를 하나 이상 100% 점유하면서 시스템이 응답하지 않는 경우: 시스템 내적인 문제 때문에 정상적인 기능을 못 하는 경우

이러한 행이 발생하는 경우 scouter의 스레드 목록이나 스레드 분석, 메모리 상황을 분석해 보면 원인에 더 쉽게 접근할 수 있다.  

#### 예외가 계속 발생해요

예외가 발생하는 원인은 애플리케이션을 잘못 코딩한 경우가 대부분이지만, 개발된 시스템의 외적인 것이 원인이 될 수도 있다.  

 - __모든 사용자가 특정 기능을 수행하면 예외가 발생하는 경우__: 특정 애플리케이션이 문제가 있는 경우
 - __특정 사용자의 특정 기능에서만 예외가 발생하는 경우__: 어떤 조건(혹은 사용자)에 따라서 발생하는 경우
 - __특정 시간대에만 전체 애플리케이션에 예외가 발생하는 경우__: 평소에나 사용자가 많지 않을 때 예외가 발생하지 않다가 사용자가 증가하거나 특정 시점이 되면 전체 애플리케이션에 발생하는 경우
 - __특정 시간대에 특정 애플리케이션에 예외가 발생하는 경우__: 평소에나  사용자가 많지 않을 때 예외가 발생하지 않다가 사용자가 증가하거나 특정 시점이 되면 특정 애플리케이션에 발생하는 경우

예외가 발생했을 때 문제의 단서가 될 수 있는 가장 큰 데이터는 __시스템 로그__ 다. 하지만, 시스템 로그는 각 시스템별로 너무 다르고 분석하는 방법이라고 할 수 있는 것이 없어 이 책에서는 다루지 않는다.  
예외 발생시 별도의 로그를 남기도록 하지 않았다면 scouter의 XLog를 사용하면 예외가 발생한 부분을 쉽게 찾을 수도 있다.  

#### 시스템이 죽어요

시스템의 프로세스가 죽는 경우로 "크래시(crash) 되었다." 혹은 "프로세스가 다운되었다."라고 표현한다.  
```bash
# PID 확인
ps -ef

# 자바 프로세스 확인
ps -ef | grep java
```

프로세스가 죽는 경우 대부분 다시는 이러한 일이 발생하지 않길 바라면서 시스템을 다시 시작한다. 만약 서버의 대수가 많고 분석할 시간적 여유가 있는 경우에는 해당 서버를  서비스에서 제외한 후 분석 작업을 실시하는 경우도 있지만, 이러한 작업을 수행할 수 있는 회사나 시스템 운영팀은 그리 많지 않을 것이다.  

### 1-2. 장애 상황을 종합해서 다시 살펴보자

#### 발생 가능한 병목 지점들

 - 애플리케이션 관점 병목 지점
    - 웹 서버
    - 웹 애플리케이션 서버(WAS)
    - 각종 API 서버
    - DB 서버
    - 데몬 프로그램
    - 레거시 시스템
    - 기타 생각지도 못한 서버
 - 서버 구성 요소 관점 병목 지점
    - CPU
    - 네트워크
    - 메모리
    - 디스크 및 파일 서버
    - OS 커널

