# 02장. 쿠버네티스 환경 구축과 예제 애플리케이션 배포

## 예제 애플리케이션의 개요와 AWS 기본

예제 애플리케이션은 마음에 드는 장소를 등록하는 서비스이다.  
장소를 표시, 등록하는 웹 애플리케이션과 장소 정보를 일괄 등록하는 배치 애플리케이션을 구성한다.  

하나는 싱글 페이지 애플리케이션의 프론트엔드와 다른 하나는 REST API를 제공하는 백엔드로 구성된 웹 애플리케이션로 구성한다. 또 하나는 스케줄되는 배치 애플리케이션이다.  

프론트엔드 애플리케이션 프로젝트를 S3에 저장하고 CloudFront를 통해 정적 웹 콘텐츠로 배포한다. 백엔드는 EKS 클러스터 워커 노드에 컨테이너로 배포하고 RDS 데이터베이스와 접속한다. 백엔드는 가용성을 고려해 로드밸런서로 부하 분산시킨다. 백엔드 애플리케이션 이미지는 ECR에 저장된다.
배치 애플리케이션은 EKS에 배포되며 S3에 저장된 파일을 처리하고 RDS에 접속하여 쓰기를 실행한다. 배치 애플리케이션 이미지는 ECR에 저장된다.  

<br/>

### AWS 관련 서비스 및 용어

 - `S3`
    - S3는 AWS가 제공하는 클라우드 스토리지 서비스이다.
    - S3에서는 스토리지의 기본 단위로 버킷이라고 불리는 영역을 생성하고 그 안에 파일을 저장한다.
 - `CloudFront`
    - CloudFront는 AWS가 제공하는 콘텐츠 전송 네트워크 서비스이다.
    - CDN은 인터넷에서 웹 콘텐츠, 이미지, 동영상, 애플리케이션 등을 빠르게 전송하기 위한 구조로 되어 있다.
    - CloudFront는 전 세계에 많은 엣지 로케이션을 갖고 있어 사용자가 접속한 가장 가까운 장소에서 콘텐츠를 제공할 수 있다.
 - `RDS`
    - RDS는 AWS가 제공하는 관계형 데이터베이스이다.
    - RDS에서는 멀티 AZ 구성을 지원하고 서비스 환경 운영에서 요구되는 가용성을 실현할 수 있다.
 - `ECR`
    - ECR은 AWS가 제공하는 컨테이너 레지스트리 관리형 서비스이다.
    - 컨테이너를 이용하여 애플리케이션을 작동시키는 경우 컨테이너 이미지를 저장하고 다운로드할 수 있는 구조로 컨테이너 레지스트리를 사용한다.
    - 컨테이너 레지스트리는 컨테이너 이미지를 보관하는 저장소로 도커 명령어를 사용하여 컨테이너 이미지를 등록 및 다운로드 할 수 있다.
 - `EC2`
    - EC2는 AWS에서 가상 머신을 사용할 수 있는 서비스로 다양한 형태의 가상 머신을 쉽게 구축하고 운영할 수 있다.
 - `ELB`
    - ELB는 AWS가 제공하는 로드밸런서 서비스이다.
    - ELB에는 ALB, NLB, GLB, CLB라는 4가지 종류의 로드밸런서를 제공한다.
    - ALB는 Application Load Balancer의 약자로 HTTP/HTTPS에 특화된 L7 로드밸런서이다. 경로 기반 라우팅, 호스트 기반 라우팅 등 HTTP 고유의 처리가 가능하다.
    - NLB는 Network Load Balancer의 약자로 L4 로드밸런서이다.
    - GLB는 Gateway Load Balancer의 약자로 다른 회사의 가상 네트워킹 어플라이언스의 배포, 확장, 실행을 돕는다. 여러 회사의 어플라이언스에 대한 로드 밸런싱 및 자동 조정 기능을 제공한다.
 - `IAM`
    - AWS IAM은 AWS 리소스에 접속하는 사용자나 권한을 관리하는 서비스이다.
    - IAM에서는 IAM 역할을 생성하여 리소스에 설정함으로써 해당 리소스에 다른 리소스에 대한 접근 권한을 부여할 수 있다.

<br/>

### EKS 구축에 사용하는 도구

 - `eksctl`

eksctl은 EKS 클러스터 구축 및 관리를 하기 위한 오픈소스 명령줄 도구이다. 'eksctl create cluster' 명령만으로 EKS 클러스터에 기본 구성을 구축할 수 있다. 또 다양한 옵션을 설정하여 유연하게 구성을 변경할 수 있다.  
eksctl을 사용하면 VPC, 서브넷, 보안 그룹 등 EKS 클러스터를 구축하는 데 필요한 리소스를 한 번에 구성할 수 있다. 그러나 eksctl로 VPC 등을 생성한 경우 EKS 클러스터를 삭제하면 VPC 등도 함꼐 삭제되어 버린다.  
때문에, VPC 등의 기본 리소스는 EKS 클러스터와 별도로 구축하는 것이 구성을 유연하게 할 수 있다.  

<br/>

 - `VPC 관련 용어`

AWS에서는 서버 등의 리소스를 VPC라는 논리적으로 분리된 영역을 이용하여 관리한다.  
1개의 AWS 계정에 VPC 여러 개를 생성할 수 있지만 기본적으로 VPC끼리는 독립적인 환경이고 명시적으로 VPC를 연결하지 않는 한 VPC간 통신은 할 수 없다.  

AWS 데이터센터는 전 세계에 존재하지만 모두 리전이라고 하는 지리적 영역에 속한 형태이다. 리전 안에는 가용 영역이 여러 개 있다. 가용 영역들은 리전 내에서 물리적으로 떨어진 장소에 존재하므로 가용 영역 여러 개에 리소스를 배포하여 다중화해두면 데이터센터 수준의 장애가 발생해도 서비스를 계속할 수 있다.  

VPC는 서브넷을 사용해 네트워크를 분할하여 관리한다. 서브넷은 가용 영역 여러 개를 동시에 사용할 수 없으며 가용 영역 여러 개를 사용할 경우 서브넷도 그만큼 나눠야 한다.  

<br/>

 - `CloudFormation을 이용한 환경 구축`

AWS 리소스는 AWS 관리 콘솔이나 AWS CLI 등 여러 방법으로 구축 가능하지만, 관련 리소스를 한 번에 구축하고 필요에 따라 변경 및 삭제할 때는 CloudFormation이 적합하다.  
CloudFormation에서는 JSON 또는 YAML 형식으로 리소스 구성을 정의한다.  

<br/>

## EKS 클러스터 구축

 - `CloudFormation 스택 생성`
    - 스택이란 CloudFormation으로 생성하는 리소스를 말한다. 템플릿을 지정하여 '스택'을 생성하거나 이미 생성한 '스택'을 삭제하면 포함된 리소스를 한 번에 삭제할 수 있다.
```
 - CloudFormation 대시 보드 > 스택 생성
    - 템플릿 준비: 준비된 템플릿
    - 템플릿 소스: 템플릿 파일 업로드 (01.base_resources_cfn.yaml)
    - 스택 이름: EKS-WORK-BASE
```

