# 06장. 엘라스틱빈스톡 & 데이터베이스

엘라스틱빈스톡과 RDS를 결합하여 프로젝트를 배포한다.  
RDS 구성 방법과 환경 속성을 세팅하는 방법을 배우고, VPC 구성에 대해서 학습한다.  

<br/>

## 엘라스틱빈스톡 생성

 - `엘라스틱빈스톡 환경 구축`
    - 환경 속성은 셸에서 사용하는 값이 아닌, 사용 중인 플랫폼을 기반으로 애플리케이션이 실행되는 스택을 통해 애플리케이션에 제공되는 변수다.
```
 - 기본 옵션
    - 애플리케이션 이름: aws-v4-beanstalk
    - 플랫폼: Java
    - 애플리케이션 코드: 샘플 애플리케이션
 - 추가 옵션
    - 사전 설정: 단일 인스턴스 (단일 인스턴스는 로드밸런서가 생성되지 않는다.)
    - 소프트웨어 편집 > 환경 속성
        - RDS_HOSTNAME: IP 주소
        - RDS_DB_NAME: testdb
        - RDS_PORT: 3306
        - RDS_USERNAME: test
        - RDS_PASSWORD: 1234
```

<br/>

## VPC 구성

엘라스틱빈스톡을 생성하면 EC2가 만들어지고 EC2는 VPC 내부에 생성된다.  
VPC는 퍼블릭 클라우드 환경에서 사용하는 가상 네트워크이다.  

외부에서 접근 가능한 VPC 하나와 내부에서만 접근 가능한 VPC 하나를 두고 사용할 수 있다.  
데이터베이스와 같이 중요한 데이터가 저장되어 있는 서버는 외부에서 접근하지 못하게 하고, 내부에 있는 EC2에서만 접근할 수 있도록 할 수 있다.  
또한, 포트는 개방하되 특정 IP만 접근 가능하게 할 수 있다.  
또한, 같은 보안 그룹끼리 접근 가능하도록 설정할 수 있다.  

 - `CIDR`
    - CIDR은 IP 주소와 서브넷마스크를 같이 표기한 것이다.
    - 'IP주소/서브넷마스크'로 표기한다.
```
 - 192.168.50.0/24
/24는 24개의 비트를 네트워크 영역으로 사용하는 것을 의미한다.
총 32개 비트로 나머지 8개 비트가 호스트 영역이 된다.
즉, 192.168.50.0은 네트워크 주소이고, 8개 비트(256)개인  192.168.50.0 ~ 192.168.50.255 범위 내에서 호스트를 사용한다.
```

<br/>

 - `서브넷`
    - VPC를 하나의 큰 망으로 보고, 서브넷은 작은 단위의 망이라고 볼 수 있다.
    - VPC가 256개의 호스트를 가진다면 서브넷에서 더 세밀하게 망을 구성할 수 있다.
```
 - 관리용으로 사용할 서브넷: 32개의 호스트
    - bastion 서버로 사용

 - 내부망으로 사용할 서브넷: 32개의 호스트
    - Database 등 외부에 직접 노출하지 않을 인프라 구성
    - VPC 내부에서만 접근 가능

 - 외부망으로 사용할 서브넷: 64개의 호스트, 2개 구성
    - 외부에서 접속 가능한 애플리케이션 구성
    - 외부의 트래픽을 견뎌야 하기 때문에 호슽의 수를 가장 많이 할당 (총 128개)
    - 리전은 서울로 선택
    - 가용 영역은 ap-northeast-2a, 2b, 2c, 2d가 존재

 - AZ는 데이터 센터를 의미한다.

 - 특정 AZ가 장애가 발생해도 서비스를 유지하려면 2개의 서브넷을 다른 AZ로 생성하는 것이 좋다.

```

<br/>

## RDS 생성 및 접속

 - `RDS 생성`
    - RDS를 생성하고, 인바운드 규칙을 편집한다.
    - 내 로컬 IP에서 접근 가능하도록 인바운드 규칙으로 3306 포트를 내 IP만 허용하게 해준다.
    - 또한, 프로젝트 내에서 데이터베이스 연결을 위해 같은 보안 그룹에서 모두 접근 가능하게 설정해준다.
```
1. RDS 대시보드 > 데이터베이스 생성
 - 엔진 옵션: Maria DB
 - Virtual Private Cloud(VPC): Default VPC
 - 서브넷 그룹: default-vpc-..
 - 퍼블릭 액세스: 예
 - VPC 보안 그룹: 기존 항목 선택
 - DB 구성
    - 이름: aws-v4-rds
    - 마스터 사용자 이름: test
    - 비밀번호: 1234
    - 데이터베이스 포트: 3306

2. 인바운드 규칙 편집
 - 사용자 지정 TCP
    - 포트범위: 3306
    - 소스: 내IP
 - 사용자 지정 TCP
    - 포트범위: 3306
    - 소스: 보안 그룹 지정 (RDS와 EC2가 같은 보안그룹에 있어야 한다.)

3. 정리
 - VPC가 외부 접근 가능한 상태
 - EC2는 22, 80, 3306 포트가 열려있는 상태
    - 22, 80번 포트는 누구나 접근 가능
    - 3306 포트는 내 컴퓨터, 같은 보안 그룹만 접근 가능
 - EC2가 RDS에 접근, RDS는 EC2와 같은 보안 그룹으로 묶여있는 상태
    - 22, 80번 포트는 누구나 접근 가능
    - 3306 포트는 내 컴퓨터, 같은 보안 그룹만 접근 가능
```

<br/>

 - `RDS 접속`
    - RDS에 접속하기 위해 RDBMS Client Tool을 이용할 수 있다.
    - HeidiSQL: https://www.heidisql.com/download.php
```
이름: aws-v4-maria
호스트명: RDS에 엔드포인트 정보
사용자: test
비밀번호: 1234
```

<br/>

 - `RDS 세팅`
```sql
-- 데이터베이스 생성
CREATE DATABASE testdb;

-- 데이터베이스 선택
USE testdb;

-- 테이블 생성
CREATE TABLE Book (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255),
    content VARCHAR(255),
    author VARCHAR(255)
);

-- 데이터베이스 문자 인코딩 세팅 확인
SHOW VARIABLES LIKE 'c%';

```
