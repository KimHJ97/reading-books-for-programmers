# 05장. 엘라스틱빈스톡으로 배포하기

AWS Elastic Beanstalk는 개발자가 애플리케이션을 손쉽게 배포하고 운영할 수 있도록 지원하는 서비스 중 하나입니다. 이 서비스를 사용하면 개발자는 인프라 관리에 신경 쓰지 않고 애플리케이션 코드에 집중할 수 있습니다.  

Elastic Beanstalk은 여러 프로그래밍 언어 및 웹 서버 플랫폼을 지원하며, 애플리케이션의 배포, 운영, 확장을 자동화합니다. 코드를 업로드하기만 하면 Elastic Beanstalk은 지속적인 완전 관리형 패치 및 보안 업데이트를 통해 용량 프로비저닝, 로드 밸런싱, 자동 조정부터 웹 애플리케이션 상태 모니터링에 이르는 배포 작업을 자동으로 처리한다.  

Elastic Beanstalk는 이미 필요한 소프트웨어들이 설치되어있어 OS 설치나 JDK 설치 과정이 필요하지 않습니다.  

 - 플랫폼 지원: Java, .NET, PHP, Node.js, Python, Ruby, Go 등 다양한 프로그래밍 언어 및 웹 서버 플랫폼을 지원합니다.
 - 자동 스케일링: 트래픽이 증가하면 Elastic Beanstalk이 자동으로 확장하여 더 많은 리소스를 프로비저닝하고, 트래픽이 감소하면 자동으로 축소하여 비용을 절감합니다.
 - 환경 관리: 배포, 스케일링, 로깅, 모니터링 등 다양한 환경 관리 기능을 제공하여 개발자가 애플리케이션을 효과적으로 운영할 수 있도록 도와줍니다.
 - 데이터베이스 통합: Elastic Beanstalk은 Amazon RDS와 같은 AWS 데이터베이스 서비스와 쉽게 통합할 수 있습니다.
 - 강력한 툴 지원: AWS Management Console, AWS CLI, AWS SDK 등 다양한 툴을 사용하여 Elastic Beanstalk을 관리할 수 있습니다.
 - 다양한 환경 유형: 싱글 인스턴스, 로드 밸런싱된 환경, 멀티컨테이너 도커 환경 등 다양한 환경 유형을 지원합니다.

<br/>

## 엘라스틱빈스톡 만들기

### 엘라스틱빈스톡 샘플 애플리케이션 실행하기

 - `샘플 애플리케이션 만들기`
```
1. Elastic Beanstalk 대시 보드 > Create Application
 - 애플리케이션 정보
    - 애플리케이션 이름: aws-v3
 - 플랫폼
    - 플랫폼: Java
    - 플랫폼 브랜치: Corretto 17 running on 64bit Amazon Linux 2
    - 플랫폼 버전: 3.3.1 (Recommended)
 - 애플리케이션 코드
    - 샘플 애플리케이션

2. 샘플 코드가 몇번 포트로 돌고 있는지 확인
 - 브라우저에서 EC2 서버 IP 주소로 접속한다.
 - 개발자 도구 > 네트워크탭 > HTTP Header(Remote Address)로 요청 IP와 포트 확인 가능
```

<br/>

### 엘라스틱빈스톡 내부 구성

엘라스틱빈스톡으로 환경을 생성하면 EC2 서버가 하나 만들어지고, 서버 내부에 JDK 설치와 Nginx 서버도 생성된다.  
기본적으로 Nginx(프록시 서버)가 80번 포트로 요청을 받고, 샘플 코드가 올라가있는 서버는 5000번 포트로 돌고 있다.  
추가적으로 EC2 서버의 앞단에 로드밸런서가 생성된다. 로드밸런서가 가장 앞단에서 80번 포트로 리스닝(대기)하며 클라이언트의 요청을 받고, 서버로 전달해준다.  

로드밸런서의 리스너 탭으로가면 80번 포트로 대기하고 있고, EC2 서버로 전달하는 규칙이 추가되어 있다.  
EC2도 80번 포트로 리스닝 중이며, Nginx가 해당 요청을 받고 5000번 포트로 리스닝 중인 서버로 전달해준다.  
이때, Nginx는 외부의 모든 요청은 거부하고, 내부의 로드배럴ㄴ서의 요청만 허용하도록 되어있다.  

로드밸런서와 EC2가 같은 보안 그룹으로 묶여 있고, EC2는 같은 보안 그룹의 80번 포트 요청만 허용하고 있다.  

 - `엘라스틱빈스톡 기본 흐름`
    - 클라이언트 80번 포트 요청 > 로드 밸런서 80번 포트 요청 > Nginx 서버 5000번 포트 요청 > Spring 서버
```
1. 외부에서 오는 모든 요청은 가장 앞단에 로드밸런서에게 포워딩된다.
2. 로드 밸런서는 80번 포트 요청만 허용한다.
3. 로드 밸런서는 80번 포트로 들어오는 요청을 EC2에게 포워딩한다.
4. EC2는 같은 보안 그룹에 묶인 로드 밸런서의 80번 포트 요청만 허용한다.
5. EC2가 80번 포트 요청을 받으면 Nginx가 이를 처리한다.
6. Nginx는 80번 포트로 요청이 들어오면 내부의 스프링서버에게 포워딩한다. 
 - 이떄, 5000번 포트로 포워딩하기 때문에 스프링 서버가 5000번 포트로 실행되어야 한다.
7. 엘라스틱빈스톡으로 생성된 스프링 서버는 샘플 코드로 실행된 서버로, 5000번 포트로 실행된다.
```

<br/>

### 엘라스틱빈스톡으로 프로젝트 배포

샘플 코드가 아닌 우리의 프로젝트를 엘라스틱빈스톡에 업로드하여 배포한다.  
로컬에 소스 코드를 받고, 빌드를 진행하여 Jar 파일을 만들어준다.  

 - `프로젝트 빌드 및 배포`
    - 로컬에서 프로젝트를 빌드하여 Jar 파일로 만들고, 해당 Jar 파일을 엘라스틱빈스톡에 업로드한다.
    - 엘라스틱빈스톡 생성 시에 상태 검사 경로가 기본적으로 '/' 엔드포인트로 되어있다. 때문에, Spring 프로젝트 내부에 '/' 요청을 받을 수 있는 엔드포인트를 만들어주어야 한다. 만약, 해당 요청을 받지 못하면 애플리케이션이 정상적으로 배포되었지만, 엘라스틱빈스톡에는 '심각' 상태로 배포된 것으로 표시된다.
```
1. 프로젝트 빌드
 - 소스 코드 다운로드
    - git clone 깃허브주소
 - 소스 코드 빌드
    - ./gradlew build

2. 프로젝트 업로드 및 배포
 - 엘라스틱빈스톡 환경 > 업로드 및 배포
    - 애플리케이션 업로드: 파일 선택 > aws-v3-0.0.3.jar
    - 버전 레이블: aws-v3-0.0.3
```

<br/>

### 엘라스틱빈스톡 SSH 접속

생성된 EC2 서버에 접속하기 위해서는 22번 포트가 열려있어야 한다.  
또한, 서버에 접속하기 위해서는 RSA 키 설정이 되어있어야 한다.  
내부적으로 Nginx를 통해 자바 서버로 연결되는 과정을 확인하기 위해 SSH로 EC2 서버에 접속한다.  

 - 
```Bash
# java와 nginx 프로세스를 확인
$ ps -ef

# 포트 확인: Nginx 서버가 80번 포트, Spring 서버가 5000번 포트로 실행 중이다.
$ netstat -nltp

# Nginx 찾기
$ sudo find / -name nginx

# nginx 설정 확인
$ cd /etc/nginx
$ vi nginx.conf # 내부적으로 conf.d/elasticbeanstalk/*.conf 파일을 include 하고 있다.

cd conf.d/elasticbeanstalk
$ vi 00_application.conf # 80번 포트 요청을 5000번 포트로 프록시 패스해준다.

```
